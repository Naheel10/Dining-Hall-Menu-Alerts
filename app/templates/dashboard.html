{% extends 'base.html' %}
{% block content %}
<div class="mb-3">
  <h1 class="h3 mb-1">Dashboard</h1>
  <p class="text-muted mb-0">Manage your favorites and alert preferences.</p>
</div>

<div class="row g-4 align-items-start">
  <div class="col-lg-5">
    <section class="card app-card border-0 h-100">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 class="h4 mb-0">Favorite items</h1>
          <span class="badge rounded-pill text-bg-light">{{ favorites|length }} saved</span>
        </div>

        <form method="post" class="d-flex gap-2 mb-4">
          <input type="hidden" name="action" value="add_favorite" />
          <input class="form-control" name="item_name" placeholder="e.g. Chicken Tikka" />
          <button class="btn btn-danger" type="submit">Add</button>
        </form>

        {% if favorites %}
        <div class="d-flex flex-wrap gap-2">
          {% for fav in favorites %}
          <div class="favorite-chip d-flex align-items-center gap-2">
            <span>{{ fav.item_name }}</span>
            <form method="post" class="d-inline">
              <input type="hidden" name="action" value="delete_favorite" />
              <input type="hidden" name="favorite_id" value="{{ fav.id }}" />
              <button class="chip-delete-btn" type="submit" aria-label="Delete {{ fav.item_name }}">
                <i class="bi bi-trash3"></i>
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state-sm text-muted">
          <i class="bi bi-bookmark-x"></i>
          <p class="mb-0 mt-2">No favorites yet. Add a few to start matching menus.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <div class="col-lg-7">
    <div class="row g-4">
      <div class="col-12">
        <section class="card app-card border-0">
          <div class="card-body p-4">
            <h2 class="h5 mb-3">Preferences</h2>
            <form method="post">
              <input type="hidden" name="action" value="update_preferences" />

              <div class="mb-4">
                <label class="form-label fw-semibold">Dining halls</label>
                <div class="row row-cols-1 row-cols-sm-2 g-2">
                  {% for hall in dining_halls_options %}
                  <div class="col">
                    <label class="pref-option w-100">
                      <input
                        class="form-check-input me-2"
                        type="checkbox"
                        name="dining_halls"
                        value="{{ hall }}"
                        {% if hall in user.dining_halls_list() %}checked{% endif %}
                      />
                      <span class="small">{{ hall }}</span>
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label fw-semibold">Meals</label>
                <div class="d-flex flex-wrap gap-2">
                  {% for meal in meal_options %}
                  <label class="meal-pill">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="meals"
                      value="{{ meal }}"
                      {% if meal in user.meals_list() %}checked{% endif %}
                    />
                    <span>{{ meal }}</span>
                  </label>
                  {% endfor %}
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label fw-semibold" for="notification-frequency">Notification frequency</label>
                <select class="form-select" id="notification-frequency" name="notification_frequency">
                  <option value="every_morning" {% if user.notification_frequency == 'every_morning' %}selected{% endif %}>Check every morning</option>
                  <option value="once_per_day" {% if user.notification_frequency == 'once_per_day' %}selected{% endif %}>Check once per day</option>
                </select>
              </div>

              <button class="btn btn-danger" type="submit">Save preferences</button>
            </form>
          </div>
        </section>
      </div>

      <div class="col-12">
        <section class="card app-card border-0">
          <div class="card-body p-4">
            <div class="d-flex flex-wrap justify-content-between gap-3 mb-4">
              <h2 class="h5 mb-0">Alerts &amp; status</h2>
              <form method="post">
                <input type="hidden" name="action" value="manual_check" />
                <button class="btn btn-danger" id="manual-check-btn" type="submit">
                  <i class="bi bi-lightning-charge-fill me-1"></i>Run menu check now
                </button>
              </form>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-sm-6">
                <div class="status-box">
                  <div class="small text-muted">Logged in user</div>
                  <div class="fw-semibold">{{ user.email }}</div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="status-box">
                  <div class="small text-muted">Last manual check</div>
                  <div class="fw-semibold">
                    {% if user.last_checked_at %}
                    {{ user.last_checked_at.strftime('%b %d, %Y at %I:%M %p UTC') }}
                    {% else %}
                    Never
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-4"><div class="stat-chip"><span>Favorites</span><strong>{{ favorites|length }}</strong></div></div>
              <div class="col-4"><div class="stat-chip"><span>Checks run</span><strong>{% if checks_run is defined %}{{ checks_run }}{% else %}â€”{% endif %}</strong></div></div>
              <div class="col-4"><div class="stat-chip"><span>Matches found</span><strong>{% if matches_found is defined %}{{ matches_found }}{% else %}{{ upcoming_matches|length }}{% endif %}</strong></div></div>
            </div>
          </div>
        </section>
      </div>

      <div class="col-12">
        <section class="card app-card border-0">
          <div class="card-body p-4">
            <h2 class="h5 mb-3">Upcoming matches</h2>
            {% if upcoming_matches %}
            <div class="table-responsive">
              <table class="table app-table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Favorite</th>
                    <th>Menu item</th>
                    <th>Dining hall</th>
                    <th>Meal</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  {% for match in upcoming_matches %}
                  <tr>
                    <td>{{ match.favorite_item_name }}</td>
                    <td>{{ match.menu_item_name }}</td>
                    <td><span class="badge text-bg-light">{{ match.dining_hall }}</span></td>
                    <td><span class="badge text-bg-danger-subtle text-danger-emphasis">{{ match.meal or 'N/A' }}</span></td>
                    <td>{{ match.menu_date }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="empty-state">
              <i class="bi bi-calendar2-heart"></i>
              <h3 class="h6 mt-3">No upcoming matches yet</h3>
              <p class="text-muted mb-0">None of your favorites appear in the current lookahead window. Try adding more favorites or running another check soon.</p>
            </div>
            {% endif %}
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

<section class="card app-card border-0 mt-4">
  <div class="card-body p-4">
    <h2 class="h5 mb-2">Sample upcoming menu (demo)</h2>
    <p class="text-muted small mb-3">
      In the hosted demo, external menu calls may be disabled; this section illustrates how real matches would appear.
    </p>
    <div class="table-responsive">
      <table class="table app-table table-sm mb-0">
        <thead>
          <tr><th>Date</th><th>Dining Hall</th><th>Meal</th><th>Item</th></tr>
        </thead>
        <tbody>
          <tr><td>2026-02-22</td><td>Gordon Avenue Market</td><td>Dinner</td><td>Spicy Chicken</td></tr>
          <tr><td>2026-02-23</td><td>Four Lakes Market</td><td>Lunch</td><td>Veggie Pizza</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const manualCheckButton = document.getElementById('manual-check-btn');
  if (manualCheckButton) {
    manualCheckButton.addEventListener('click', () => {
      manualCheckButton.disabled = true;
      manualCheckButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Checking...';
    });
  }
</script>
{% endblock %}
